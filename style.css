// Screen switching with fades
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  el.classList.add('active');
  if (id === 'login' || id === 'home') el.classList.add('fade-in');
}

window.addEventListener('load', () => {
  // Splash -> login (with fade-out)
  setTimeout(() => {
    const splash = document.getElementById('splash');
    splash.classList.add('fade-out');
    setTimeout(() => showScreen('login'), 800);
  }, 2200);

  // Login events
  document.getElementById('loginBtn').addEventListener('click', startApp);
  document.getElementById('username').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') startApp();
  });

  // Search events
  document.getElementById('searchBtn').addEventListener('click', runSearch);
  document.getElementById('feelingLuckyBtn').addEventListener('click', feelingLucky);
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') runSearch();
  });

  // Customize modal + settings
  setupCustomizeModal();

  // Shortcuts
  loadShortcuts();
  document.getElementById('addShortcutBtn').addEventListener('click', addShortcutPrompt);

  // Lens + mic + AI
  document.getElementById('lensBtn').addEventListener('click', openLensOverlay);
  document.getElementById('micBtn').addEventListener('click', startVoiceSearch);
  document.getElementById('aiBtn').addEventListener('click', toggleAIMode);

  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
});

function startApp() {
  const name = document.getElementById('username').value.trim();
  if (!name) return;
  localStorage.setItem('nexusUser', name);

  // Login -> Loading Nexus interstitial
  showScreen('loading');
  setTimeout(() => {
    // Loading -> Home with fade in
    showScreen('home');
    // Apply stored background + accent
    applySavedBackground();
    const savedAccent = localStorage.getItem('nexusAccent');
    if (savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);
    document.querySelector('.nexus-brand').classList.add('fade-in');
  }, 1400);
}

// Search using your proxy endpoint
async function runSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '<div class="spinner" style="margin: 0 auto;"></div>';

  try {
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    resultsEl.innerHTML = '';
    data.results.forEach(item => {
      const card = document.createElement('div');
      card.className = 'result-card fade-in';
      card.innerHTML = `<a href="${item.link}" target="_blank">${item.title}</a><p>${item.snippet}</p>`;
      resultsEl.appendChild(card);
    });
  } catch (err) {
    resultsEl.innerHTML = `<p style="color:#f88;">Failed to fetch results.</p>`;
  }
}

function feelingLucky() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return runSearch();
  window.open(`/api/search?lucky=1&q=${encodeURIComponent(q)}`, '_blank');
}

// Voice search across languages
function startVoiceSearch() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return alert('Voice search not supported in this browser.');
  const rec = new SpeechRecognition();
  rec.lang = localStorage.getItem('nexusLang') || 'en-US'; // user-settable later
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    document.getElementById('searchInput').value = transcript;
    runSearch();
  };
  rec.onerror = () => alert('Voice recognition error.');
  rec.start();
}

// AI Mode placeholder
let aiMode = false;
function toggleAIMode() {
  aiMode = !aiMode;
  document.getElementById('aiBtn').textContent = aiMode ? 'AI ON' : 'AI';
  // In AI mode, you might route to a different endpoint or change rendering.
}

// Customize modal logic
function setupCustomizeModal() {
  const modal = document.getElementById('customizeModal');
  const btn = document.getElementById('customizeBtn');
  const closeBtn = document.getElementById('closeCustomize');
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-panel');
  const bgButtons = document.querySelectorAll('.bg-item');
  const upload = document.getElementById('bgUpload');
  const resetBg = document.getElementById('resetBg');
  const accentPicker = document.getElementById('accentPicker');
  const aiToggle = document.getElementById('aiToggle');

  btn.addEventListener('click', () => modal.classList.add('show'));
  closeBtn.addEventListener('click', () => modal.classList.remove('show'));

  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-' + t.dataset.tab).classList.add('active');
  }));

  bgButtons.forEach(b => b.addEventListener('click', () => {
    if (b.dataset.bg === 'custom') upload.click();
    else setBackground(b.dataset.bg);
  }));
  upload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => setBackground(reader.result);
    reader.readAsDataURL(file);
  });
  resetBg.addEventListener('click', () => setBackground('black'));

  accentPicker.addEventListener('input', (e) => {
    document.documentElement.style.setProperty('--accent', e.target.value);
    localStorage.setItem('nexusAccent', e.target.value);
  });

  aiToggle.addEventListener('change', (e) => {
    document.getElementById('aiBtn').style.display = e.target.checked ? 'inline-block' : 'none';
    localStorage.setItem('nexusAIModeToggle', e.target.checked ? '1' : '0');
  });

  // Restore settings
  const savedAccent = localStorage.getItem('nexusAccent');
  if (savedAccent) {
    accentPicker.value = savedAccent;
    document.documentElement.style.setProperty('--accent', savedAccent);
  }
  const savedToggle = localStorage.getItem('nexusAIModeToggle');
  if (savedToggle !== null) {
    const show = savedToggle === '1';
    aiToggle.checked = show;
    document.getElementById('aiBtn').style.display = show ? 'inline-block' : 'none';
  }
}

function setBackground(value) {
  if (value === 'black') {
    document.documentElement.style.setProperty('--bg', '#000');
    document.body.style.backgroundImage = '';
  } else if (value.startsWith('assets/') || value.startsWith('data:image')) {
    document.body.style.backgroundImage = `url("${value}")`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  } else {
    document.documentElement.style.setProperty('--bg', value);
    document.body.style.backgroundImage = '';
  }
  localStorage.setItem('nexusBg', value);
}

function applySavedBackground() {
  const saved = localStorage.getItem('nexusBg') || 'black';
  setBackground(saved);
}

// Shortcuts
function loadShortcuts() {
  const grid = document.getElementById('shortcutGrid');
  const data = JSON.parse(localStorage.getItem('nexusShortcuts') || '[]');
  grid.innerHTML = '';
  data.forEach((s, i) => {
    const el = document.createElement('div');
    el.className = 'shortcut';
    el.innerHTML = `<strong>${s.name}</strong><br><span>${s.url}</span>`;
    el.onclick = () => window.open(s.url, '_blank');
    el.oncontextmenu = (e) => {
      e.preventDefault();
      const confirmRemove = confirm(`Remove shortcut "${s.name}"?`);
      if (confirmRemove) {
        data.splice(i, 1);
        localStorage.setItem('nexusShortcuts', JSON.stringify(data));
        loadShortcuts();
      }
    };
    grid.appendChild(el);
  });
}

function addShortcutPrompt() {
  const name = prompt('Shortcut name');
  if (!name) return;
  const url = prompt('Shortcut URL (include https://)');
  if (!url) return;
  const data = JSON.parse(localStorage.getItem('nexusShortcuts') || '[]');
  data.push({ name, url });
  localStorage.setItem('nexusShortcuts', JSON.stringify(data));
  loadShortcuts();
}

// Lens overlay (placeholder interaction)
function openLensOverlay() {
  alert('Nexus Lens: Coming soon. Upload an image or paste a URL to analyze.');
}
